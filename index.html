<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EchoAI</title>
  <style>
    /* Styles unchanged for brevity */
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f9f9f9; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow-x: hidden; }
    header { margin-top: 50px; font-size: 2rem; font-weight: bold; }
    #chat-container { width: 90%; max-width: 800px; margin-top: 20px; display: flex; flex-direction: column; }
    #chat { flex-grow: 1; overflow-y: auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-height: 300px; margin-bottom: 20px; }
    .message { margin-bottom: 15px; }
    .message.user { text-align: right; font-weight: bold; }
    .message.ai { text-align: left; color: #333; }
    .message img { max-width: 250px; border-radius: 10px; margin-top: 5px; }
    #input-container { display: flex; align-items: center; background: white; border-radius: 30px; padding: 10px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    #prompt { border: none; flex: 1; outline: none; font-size: 1rem; }
    #model-select { margin-left: 10px; border: none; font-size: 1rem; background: #f0f0f0; padding: 5px; border-radius: 8px; }
    #send, #mic, #upload-img { background: black; color: white; border: none; padding: 10px; margin-left: 10px; border-radius: 50%; cursor: pointer; }
    #mic:hover, #send:hover, #upload-img:hover { background: #333; }
    #loader span { font-size: 1.2rem; animation: blink 1.5s infinite; }
    @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }
    #options { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
    .option-btn { padding: 8px 12px; background: #eee; border: none; border-radius: 20px; cursor: pointer; font-size: 0.9rem; }
    .option-btn:hover { background: #ddd; }
  </style>
</head>
<body>

<header>What can I help with?</header>

<div id="chat-container">
  <div id="chat"></div>

  <div id="options">
    <button class="option-btn" onclick="quickInsert('Search')">üåê Search</button>
    <button class="option-btn" onclick="quickInsert('Reason')">üí° Reason</button>
    <button class="option-btn" onclick="quickInsert('Deep research')">üìö Deep Research</button>
    <button class="option-btn" onclick="quickInsert('Create image')">üé® Create Image</button>
  </div>

  <div id="input-container">
    <input type="text" id="prompt" placeholder="Ask anything..." />
    <select id="model-select">
      <option value="openai">OpenAI</option>
      <option value="mistral">Mistral</option>
      <option value="searchgpt">SearchGPT</option>
      <option value="claude-hybridspace">Claude Hybridspace</option>
      <option value="openai-large">OpenAI Large (Vision)</option>
      <option value="o3-mini">O3 Mini</option>
    </select>
    <button id="upload-img" onclick="document.getElementById('imgInput').click()">üì∑</button>
    <button id="mic" onclick="startListening()">üéôÔ∏è</button>
    <button id="send" onclick="handleInput()">‚û§</button>
    <input type="file" id="imgInput" style="display:none" accept="image/*" onchange="handleImageUpload(event)">
  </div>
</div>

<script>
let chatHistory = [];
let recognition;

function quickInsert(type) {
  const promptInput = document.getElementById('prompt');
  const modelSelect = document.getElementById('model-select');

  if (type === "Search") {
    promptInput.value = "Search:";
    modelSelect.value = "searchgpt";
  } else if (type === "Reason") {
    promptInput.value = "Reason:";
    modelSelect.value = "mistral";
  } else if (type === "Deep Research") {
    promptInput.value = "Deep Research:";
    modelSelect.value = "searchgpt";
  } else if (type === "Create image") {
    promptInput.value = "Create image:";
  }
}

async function handleInput() {
  const promptInput = document.getElementById('prompt');
  const prompt = promptInput.value.trim();
  if (!prompt) return;

  addMessage('user', prompt);
  promptInput.value = '';

  let model = document.getElementById('model-select').value;

  if (/^(create|generate|draw|paint)\s+image/i.test(prompt)) {
    const cleaned = prompt.replace(/^(create|generate|draw|paint)\s+image\s*/i, '');
    return generateImage(cleaned || "a beautiful scene");
  }

  if (/^search:/i.test(prompt)) model = "searchgpt";
  if (/^reason:/i.test(prompt)) model = "mistral";
  if (/^deep research:/i.test(prompt)) {
    model = "searchgpt";
    prompt = prompt.replace(/^deep research:/i, '') + " (Respond with thorough research, include sources if possible)";
  }
  if (/analyze/i.test(prompt)) model = "openai-large";
  if (/speak|say/i.test(prompt)) {
    model = "openai-audio";
    return generateSpeech(prompt.replace(/^(speak|say)\s*/i, ''));
  }

  await streamChat(prompt, model);
}

function addMessage(role, content, isImage = false) {
  const chat = document.getElementById('chat');
  const div = document.createElement('div');
  div.className = 'message ' + role;
  div.innerHTML = isImage ? `<img src="${content}" />` : content;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function streamChat(userPrompt, model) {
  const loaderDiv = document.createElement('div');
  loaderDiv.className = 'message ai';
  loaderDiv.innerHTML = 'Thinking...';
  document.getElementById('chat').appendChild(loaderDiv);

  try {
    const messages = [...chatHistory, {role: "user", content: userPrompt}];
    const res = await fetch("https://text.pollinations.ai/openai", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "text/event-stream" },
      body: JSON.stringify({ model, messages, stream: true })
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let fullText = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value);
      const lines = chunk.split('\n\n');
      for (const line of lines) {
        if (line.startsWith("data: ")) {
          try {
            const json = JSON.parse(line.slice(6));
            const delta = json.choices?.[0]?.delta?.content;
            if (delta) {
              fullText += delta;
              loaderDiv.textContent = fullText + getLoadingDots();
              loaderDiv.scrollIntoView({ behavior: "smooth", block: "end" });
            }
          } catch (e) {
            console.warn("JSON parse error:", e);
          }
        }
      }
    }

    loaderDiv.textContent = fullText;
    chatHistory.push({role: "user", content: userPrompt}, {role: "assistant", content: fullText});

  } catch (error) {
    loaderDiv.textContent = "‚ùå Error! Could not get a response.";
    console.error("Stream error:", error);
  }
}

function getLoadingDots() {
  const dots = ["", ".", "..", "..."];
  return dots[Math.floor(Date.now() / 300) % 4];
}

function generateImage(prompt) {
  const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
  addMessage('ai', url, true);
}

function startListening() {
  if (!recognition) {
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "en-US";
    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      document.getElementById('prompt').value = transcript;
      handleInput();
    };
  }
  recognition.start();
}
</script>

</body>
</html>

