<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Echo AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      background-color: #1e1e2f;
      color: #f4f4f4;
      font-family: 'Segoe UI', sans-serif;
    }
    header {
      padding: 1rem;
      background: #282c34;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      color: #61dafb;
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 60px);
    }
    .chat-history {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      background: #202030;
      border-bottom: 1px solid #333;
    }
    .chat-input {
      display: flex;
      padding: 1rem;
      gap: 0.5rem;
      background: #282c34;
    }
    textarea {
      flex: 1;
      padding: 0.5rem;
      background: #2d2d3a;
      color: #f4f4f4;
      border: none;
      border-radius: 4px;
      resize: vertical;
    }
    button {
      background: #61dafb;
      color: #000;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .message {
      margin-bottom: 1rem;
    }
    .user { color: #4ec0e9; }
    .assistant { color: #9effa5; }
    img.generated {
      display: block;
      max-width: 100%;
      margin: 1rem 0;
      border: 1px solid #444;
      border-radius: 8px;
    }
    .blinking {
      display: inline-block;
      animation: blink 1s step-end infinite;
    }
    @keyframes blink {
      50% { opacity: 0; }
    }
  </style>
</head>
<body>
  <header>
    Echo AI
    <button id="loginButton" onclick="loginPrompt()">Login to Premium</button>
    <a href="pricing.html" style="color: white; margin-left: 20px; text-decoration: none;">Pricing</a>
  </header>

  <div class="chat-container">
    <div id="chatHistory" class="chat-history"></div>
    <p id="vision-result"></p>
    <div class="chat-input">
      <textarea id="chatInput" placeholder="Ask or imagine something..."></textarea>
      <button onclick="handleSend()">Send</button>
      <button onclick="handleImage()">ðŸŽ¨</button>
      <input type="file" id="imageInput" accept="image/*">
    </div>
  </div>

  <script>
    // Check if the user is logged in and their premium status
let isPremium = localStorage.getItem('isPremium') === 'true';

function checkLoginStatus() {
  if (localStorage.getItem('isLoggedIn') === 'true') {
    document.getElementById('loginButton').style.display = 'none';  // Hide login button if already logged in
  } else {
    document.getElementById('loginButton').style.display = 'block'; // Show login button if not logged in
  }
}

checkLoginStatus();  // Call this function to check the login status when the page loads

// Function to prompt login
function loginPrompt(isPremiumPlan) {
  const username = prompt("Enter your username:");
  const password = prompt("Enter your password:");

  if (username === "premium" && password === "1234") {
    localStorage.setItem('isLoggedIn', 'true');
    localStorage.setItem('isPremium', 'true');
    isPremium = true;
    alert("Logged in as premium user!");
    checkLoginStatus(); // Refresh login status
  } else {
    localStorage.setItem('isLoggedIn', 'true');
    localStorage.setItem('isPremium', 'false');
    isPremium = false;
    alert("Incorrect credentials. You are now on the free plan.");
    checkLoginStatus(); // Refresh login status
  }
}

// Function to check if the user is navigating from the pricing page
function checkForPremiumRedirect() {
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('plan') === 'premium') {
    loginPrompt(true);  // Trigger the premium login prompt if the user is upgrading to premium
  }
}

checkForPremiumRedirect(); // Call this function to check for the "plan=premium" query parameter

const chatHistory = document.getElementById('chatHistory');
const chatInput = document.getElementById('chatInput');
let messages = JSON.parse(localStorage.getItem('chatHistory') || '[]');

function saveHistory() {
  localStorage.setItem('chatHistory', JSON.stringify(messages));
}

function renderMessages() {
  chatHistory.innerHTML = '';
  messages.forEach(msg => {
    const div = document.createElement('div');
    div.className = 'message';
    div.innerHTML = `<strong class="${msg.role}">${msg.role}:</strong> ` +
      (msg.image ? `<img class="generated" src="${msg.image}" alt="Generated Image">` : msg.content);
    chatHistory.appendChild(div);
  });
  chatHistory.scrollTop = chatHistory.scrollHeight;
}

async function handleSend() {
  const input = chatInput.value.trim();
  if (!input) return;

  messages.push({ role: 'user', content: input });
  renderMessages();
  chatInput.value = '';

  const div = document.createElement('div');
  div.className = 'message assistant';
  div.innerHTML = '<strong class="assistant">Echo:</strong> <span class="blinking">...</span>';
  chatHistory.appendChild(div);
  chatHistory.scrollTop = chatHistory.scrollHeight;

  // Add delay based on plan type
  const delay = isPremium ? 0 : 2000; // Premium gets no delay, free has a 2s delay

  setTimeout(async () => {
    const response = await fetch("https://text.pollinations.ai/openai", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "text/event-stream"
      },
      body: JSON.stringify({
        model: "openai",
        messages: messages.filter(m => !m.image),
        stream: true
      })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buffer = "";
    let fullText = "";
    div.querySelector('span').remove();
    const contentSpan = document.createElement('span');
    div.appendChild(contentSpan);

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const parts = buffer.split("\n\n");
      buffer = parts.pop();
      for (const part of parts) {
        if (part.startsWith("data: ")) {
          const data = part.slice(6).trim();
          if (data === "[DONE]") return;
          try {
            const json = JSON.parse(data);
            const chunk = json.choices?.[0]?.delta?.content;
            if (chunk) {
              fullText += chunk;
              contentSpan.textContent = fullText;
              chatHistory.scrollTop = chatHistory.scrollHeight;
            }
          } catch (err) {
            console.error("Stream error:", err);
          }
        }
      }
    }

    messages.push({ role: 'assistant', content: fullText });
    saveHistory();
  }, delay); // Apply delay if necessary
}

async function handleImage() {
  const input = chatInput.value.trim();
  if (!input) return;

  const encoded = encodeURIComponent(input);
  const url = `https://image.pollinations.ai/prompt/${encoded}?nologo=true`;
  messages.push({ role: 'user', content: input });
  messages.push({ role: 'assistant', content: '', image: url });
  saveHistory();
  renderMessages();

  const delay = isPremium ? 0 : 10000; // Premium has no delay, free has 10s delay

  setTimeout(() => {
    renderMessages();
  }, delay); // Apply delay for image generation (free plan)
}

renderMessages();
    // Check if the user is premium
let isPremium = localStorage.getItem('isPremium') === 'true';

// Function to encode file to base64
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result); // result includes 'data:mime/type;base64,' prefix
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function analyzeImage(imageFile, question = "What's in this image?") {
  // Check if user is premium before allowing image analysis
  if (!isPremium) {
    alert("This feature is only available to premium users.");
    return;
  }

  const url = "https://text.pollinations.ai/openai";

  try {
    const base64ImageDataUrl = await fileToBase64(imageFile);

    const payload = {
      model: "openai", // Ensure vision support
      messages: [
        {
          role: "user",
          content: [
            { type: "text", text: question },
            {
              type: "image_url",
              image_url: {
                url: base64ImageDataUrl,
              },
            },
          ],
        },
      ],
      max_tokens: 10000, // Optional
    };

    const response = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(
        `HTTP error! status: ${response.status}, message: ${errorText}`
      );
    }

    const result = await response.json();
    console.log("Vision Analysis:", result.choices[0].message.content);
    // Display the result
    document.getElementById('vision-result').textContent = result.choices[0].message.content;
  } catch (error) {
    console.error("Error analyzing image:", error);
  }
}
  </script>
</body>
</html>
