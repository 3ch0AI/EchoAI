<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EchoAI</title>
  <style>
     body {
      margin: 0; 
      padding: 0; 
      font-family: 'Segoe UI', sans-serif; 
      background: #f9f9f9; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      height: 100vh;
      overflow-x: hidden;
    }
    header {
      margin-top: 50px;
      font-size: 2rem;
      font-weight: bold;
    }
    #chat-container {
      width: 90%;
      max-width: 800px;
      margin-top: 20px;
      display: flex;
      flex-direction: column;
    }
    #chat {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: 300px;
      margin-bottom: 20px;
    }
    .message {
      margin-bottom: 15px;
    }
    .message.user {
      text-align: right;
      font-weight: bold;
    }
    .message.ai {
      text-align: left;
      color: #333;
    }
    .message img {
      max-width: 250px;
      border-radius: 10px;
      margin-top: 5px;
    }
    #input-container {
      display: flex;
      align-items: center;
      background: white;
      border-radius: 30px;
      padding: 10px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #prompt {
      border: none;
      flex: 1;
      outline: none;
      font-size: 1rem;
    }
    #model-select {
      margin-left: 10px;
      border: none;
      font-size: 1rem;
      background: #f0f0f0;
      padding: 5px;
      border-radius: 8px;
    }
    #send, #mic, #upload-img {
      background: black;
      color: white;
      border: none;
      padding: 10px;
      margin-left: 10px;
      border-radius: 50%;
      cursor: pointer;
    }
    #mic:hover, #send:hover, #upload-img:hover {
      background: #333;
    }
    #loader {
      display: inline-block;
    }
    #loader span {
      font-size: 1.2rem;
      animation: blink 1.5s infinite;
    }
    @keyframes blink {
      0% { opacity: 0.2; }
      20% { opacity: 1; }
      100% { opacity: 0.2; }
    }
    #options {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    .option-btn {
      padding: 8px 12px;
      background: #eee;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .option-btn:hover {
      background: #ddd;
    }
  </style>
</head>
<body>

<header>What can I help with?</header>

<div id="chat-container">
  <div id="chat"></div>

  <div id="options">
    <button class="option-btn" onclick="quickInsert('Search')">üåê Search</button>
    <button class="option-btn" onclick="quickInsert('Reason')">üí° Reason</button>
    <button class="option-btn" onclick="quickInsert('Deep research')">üìö Deep Research</button>
    <button class="option-btn" onclick="quickInsert('Create image')">üé® Create Image</button>
  </div>

  <div id="input-container">
    <input type="text" id="prompt" placeholder="Ask anything..." />
    <select id="model-select">
      <option value="openai">OpenAI</option>
      <option value="mistral">Mistral</option>
      <option value="searchgpt">SearchGPT</option>
      <option value="claude-hybridspace">Claude Hybridspace</option>
      <option value="openai-large">OpenAI Large (Vision)</option>
      <option value="o3-mini">O3 Mini</option>
      <option value="qwen-coder">Qwen Coder</option>
      <option value="llama">Llama 3.3</option>
      <option value="mistral-small">Mistral Small</option>
      <option value="deepseek">DeepSeek</option>
      <option value="phi">Phi-4 Instruct</option>
    </select>
    <button id="upload-img" onclick="document.getElementById('imgInput').click()">üì∑</button>
    <button id="mic" onclick="startListening()">üéôÔ∏è</button>
    <button id="send" onclick="handleInput()">‚û§</button>
    <input type="file" id="imgInput" style="display:none" accept="image/*" onchange="handleImageUpload(event)">
  </div>
</div>

<script>
let chatHistory = [];
let recognition;
const premiumPassword = "cjownsthis123"; // Hardcoded premium password

// Function to simulate delay based on user type (free vs premium)
async function delayExecution(isPremium, delayTime) {
  if (!isPremium) {
    await new Promise(resolve => setTimeout(resolve, delayTime)); // Apply delay for free users
  }
}

async function handleInput() {
  const promptInput = document.getElementById('prompt');
  const prompt = promptInput.value.trim();
  if (!prompt) return;

  addMessage('user', prompt);

  const modelSelect = document.getElementById('model-select');
  let selectedModel = modelSelect.value;

  const passwordInput = promptInput.value.toLowerCase(); // Assume password is part of the prompt

  // Check if the password in the prompt is premium
  const isPremium = passwordInput === premiumPassword;
  
  // If not premium, apply text delay (3 seconds for free)
  await delayExecution(isPremium, isPremium ? 0 : 3000); // 3 seconds delay for free users
  
  // Image generation check
  if (/^(create|generate|draw|paint)\s+image/i.test(prompt)) {
    const cleanedPrompt = prompt.replace(/^(create|generate|draw|paint)\s*/i, '');
    await delayExecution(isPremium, isPremium ? 0 : 10000); // 10 seconds delay for free users
    return generateImage(cleanedPrompt || "a beautiful scene", isPremium);
  }

  // Auto-detect if the prompt hints at special handling
  if (/^search:/i.test(prompt)) {
    selectedModel = "searchgpt";
  } else if (/^reason:/i.test(prompt)) {
    selectedModel = "mistral";
  } else if (/^deep research:/i.test(prompt)) {
    selectedModel = "searchgpt"; // still searchgpt
  } else if (/analyze/i.test(prompt)) {
    selectedModel = "openai-large";
  } else if (/speak|say/i.test(prompt)) {
    selectedModel = "openai-audio";
    return generateSpeech(prompt.replace(/^(speak|say)\s*/i, ''));
  }

  await streamChat(prompt, selectedModel, isPremium);
}

function addMessage(role, content, isImage = false) {
  const chat = document.getElementById('chat');
  const div = document.createElement('div');
  div.className = 'message ' + role;
  if (isImage) {
    div.innerHTML = `<img src="${content}" />`;
  } else {
    div.textContent = content;
  }
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function streamChat(userPrompt, model, isPremium) {
  addMessage('ai', 'Thinking... <span id="loader">. . .</span>'); // show loading spinner

  try {
    const messages = [...chatHistory, { role: "user", content: userPrompt }];
    const payload = {
      model: model,
      messages: messages,
      stream: true
    };

    await delayExecution(isPremium, isPremium ? 0 : 3000); // Apply 3 sec delay for free users

    const res = await fetch("https://text.pollinations.ai/openai", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "text/event-stream" },
      body: JSON.stringify(payload)
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let aiDiv = document.querySelector('.message.ai:last-child');
    let text = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value);
      chunk.split('\n\n').forEach(line => {
        if (line.startsWith('data: ')) {
          const json = JSON.parse(line.slice(6));
          const delta = json.choices?.[0]?.delta?.content;
          if (delta) {
            text += delta;
            aiDiv.textContent = text + getLoadingDots();
            aiDiv.scrollIntoView({ behavior: "smooth", block: "end" });
          }
        }
      });
    }

    aiDiv.textContent = text;
    chatHistory.push({ role: "user", content: userPrompt }, { role: "assistant", content: text });

  } catch (error) {
    console.error("Error with chat stream:", error);
    addMessage('ai', 'Error, please try again.');
  }
}

function getLoadingDots() {
  return "<span class='dot'>.</span><span class='dot'>.</span><span class='dot'>.</span>";
}

// Image generation (for image prompts)
async function generateImage(prompt, isPremium) {
  addMessage('ai', 'Generating image... <span id="loader">. . .</span>'); // show loading spinner

  await delayExecution(isPremium, isPremium ? 0 : 10000); // 10 seconds delay for free users

  const res = await fetch("https://image.pollinations.ai/generate", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const data = await res.json();
  const imgUrl = data.url;

  addMessage('ai', imgUrl, true); // Display generated image
}

async function startListening() {
  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'en-US';
  recognition.start();

  recognition.onresult = function (event) {
    const transcript = event.results[0][0].transcript;
    document.getElementById('prompt').value = transcript;
    handleInput();
  };
}

function handleImageUpload(event) {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onloadend = function () {
    addMessage('user', 'Uploaded image');
    addMessage('ai', reader.result, true); // Display uploaded image
  };
  reader.readAsDataURL(file);
}
</script>

</body>
</html>
