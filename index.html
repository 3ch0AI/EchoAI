<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EchoAI</title>
  <style>
    body {
      margin: 0; 
      padding: 0; 
      font-family: 'Segoe UI', sans-serif; 
      background: #f9f9f9; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      height: 100vh;
      overflow-x: hidden;
    }
    header {
      margin-top: 50px;
      font-size: 2rem;
      font-weight: bold;
    }
    #chat-container {
      width: 90%;
      max-width: 800px;
      margin-top: 20px;
      display: flex;
      flex-direction: column;
    }
    #chat {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: 300px;
      margin-bottom: 20px;
    }
    .message {
      margin-bottom: 15px;
    }
    .message.user {
      text-align: right;
      font-weight: bold;
    }
    .message.ai {
      text-align: left;
      color: #333;
    }
    .message img {
      max-width: 250px;
      border-radius: 10px;
      margin-top: 5px;
    }
    #input-container {
      display: flex;
      align-items: center;
      background: white;
      border-radius: 30px;
      padding: 10px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #prompt {
      border: none;
      flex: 1;
      outline: none;
      font-size: 1rem;
    }
    #model-select {
      margin-left: 10px;
      border: none;
      font-size: 1rem;
      background: #f0f0f0;
      padding: 5px;
      border-radius: 8px;
    }
    #send, #mic, #upload-img {
      background: black;
      color: white;
      border: none;
      padding: 10px;
      margin-left: 10px;
      border-radius: 50%;
      cursor: pointer;
    }
    #mic:hover, #send:hover, #upload-img:hover {
      background: #333;
    }
    #loader {
      display: inline-block;
    }
    #loader span {
      font-size: 1.2rem;
      animation: blink 1.5s infinite;
    }
    @keyframes blink {
      0% { opacity: 0.2; }
      20% { opacity: 1; }
      100% { opacity: 0.2; }
    }
    #options {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    .option-btn {
      padding: 8px 12px;
      background: #eee;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .option-btn:hover {
      background: #ddd;
    }
  </style>
</head>
<body>

<header>What can I help with?</header>

<div id="chat-container">
  <div id="chat"></div>

  <div id="options">
    <button class="option-btn" onclick="quickInsert('Search')">üåê Search</button>
    <button class="option-btn" onclick="quickInsert('Reason')">üí° Reason</button>
    <button class="option-btn" onclick="quickInsert('Deep research')">üìö Deep Research</button>
    <button class="option-btn" onclick="quickInsert('Create image')">üé® Create Image</button>
  </div>

  <div id="input-container">
    <input type="text" id="prompt" placeholder="Ask anything..." />
    <select id="model-select">
      <option value="openai">OpenAI</option>
      <option value="mistral">Mistral</option>
      <option value="searchgpt">SearchGPT</option>
      <option value="claude-hybridspace">Claude Hybridspace</option>
      <option value="openai-large">OpenAI Large (Vision)</option>
      <option value="o3-mini">O3 Mini</option>
    </select>
    <button id="upload-img" onclick="document.getElementById('imgInput').click()">üì∑</button>
    <button id="mic" onclick="startListening()">üéôÔ∏è</button>
    <button id="send" onclick="handleInput()">‚û§</button>
    <input type="file" id="imgInput" style="display:none" accept="image/*" onchange="handleImageUpload(event)">
  </div>
</div>

<script>
let chatHistory = [];
let recognition;

// Auto-insert examples
function quickInsert(text) {
  document.getElementById('prompt').value = text;
}

async function handleInput() {
  const prompt = document.getElementById('prompt').value.trim();
  if (!prompt) return;

  addMessage('user', prompt);

  const modelSelect = document.getElementById('model-select');
  let selectedModel = modelSelect.value;

  if (/draw|paint|generate image/i.test(prompt)) {
    return generateImage(prompt.replace(/^(draw|paint|generate image)\s*/i, ''));
  }
  if (/analyze/i.test(prompt)) {
    selectedModel = "openai-large";
  }
  if (/speak|say/i.test(prompt)) {
    selectedModel = "openai-audio";
    return generateSpeech(prompt.replace(/^(speak|say)\s*/i, ''));
  }

  // Regular chat
  await streamChat(prompt, selectedModel);
}

function addMessage(role, content, isImage = false) {
  const chat = document.getElementById('chat');
  const div = document.createElement('div');
  div.className = 'message ' + role;
  if (isImage) {
    div.innerHTML = `<img src="${content}" />`;
  } else {
    div.textContent = content;
  }
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function streamChat(userPrompt, model) {
  addMessage('ai', ''); // empty first
  const messages = [...chatHistory, {role: "user", content: userPrompt}];
  
  const payload = {
    model: model,
    messages: messages,
    stream: true
  };

  const res = await fetch("https://text.pollinations.ai/openai", {
    method: "POST",
    headers: { "Content-Type": "application/json", "Accept": "text/event-stream" },
    body: JSON.stringify(payload)
  });

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let aiDiv = document.querySelector('.message.ai:last-child');
  let text = '';

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    const chunk = decoder.decode(value);
    chunk.split('\n\n').forEach(line => {
      if (line.startsWith('data: ')) {
        const json = JSON.parse(line.slice(6));
        const delta = json.choices?.[0]?.delta?.content;
        if (delta) {
          text += delta;
          aiDiv.textContent = text + getLoadingDots();
          aiDiv.scrollIntoView({ behavior: "smooth", block: "end" });
        }
      }
    });
  }

  aiDiv.textContent = text;
  chatHistory.push({role: "user", content: userPrompt}, {role: "assistant", content: text});
}

function getLoadingDots() {
  const dots = ". . .";
  return dots.substring(0, Math.floor(Date.now() / 300) % 4);
}

async function generateImage(prompt) {
  const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
  addMessage('ai', url, true);
}

async function generateSpeech(text) {
  const url = `https://text.pollinations.ai/${encodeURIComponent(text)}?model=openai-audio&voice=nova`;
  const audio = new Audio(url);
  audio.play();
  addMessage('ai', "[Speaking out loud üéôÔ∏è]");
}

function startListening() {
  if (!('webkitSpeechRecognition' in window)) {
    alert('Speech recognition not supported!');
    return;
  }
  recognition = new webkitSpeechRecognition();
  recognition.continuous = false;
  recognition.lang = 'en-US';
  recognition.interimResults = false;
  recognition.start();

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    document.getElementById('prompt').value = transcript;
  };

  recognition.onerror = function(event) {
    console.error('Speech Recognition Error:', event.error);
  };
}

async function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    const base64Image = e.target.result.split(',')[1];
    const payload = {
      model: "openai-large",
      messages: [{
        role: "user",
        content: [
          { type: "text", text: "Analyze this image:" },
          { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64Image}` } }
        ]
      }]
    };

    const res = await fetch("https://text.pollinations.ai/openai", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    addMessage('ai', data.choices[0].message.content);
  };
  reader.readAsDataURL(file);
}
</script>

</body>
</html>
